# User Info 指令 v2 - 使用模式分析

## 概述

全新改版的 `user-info` 指令，使用 Discord Components v2 的現代化介面，並新增強大的使用模式分析功能，協助管理員檢測異常使用行為（如小帳、機器人刷指令等）。

## 主要功能

### 1. 📊 綜合資訊
- 使用者基本資訊（標籤、ID、建立時間）
- 最活躍的伺服器 Top 10
- 最常用指令 Top 10

### 2. 💰 財務總覽 ⭐ 優化
- 帳戶餘額（油幣、油票）- 使用千分位格式化
- 交易統計（總轉入、總轉出、淨收入）- 帶趨勢 emoji
- **主要支出項目分析** - 按類別分組顯示
  - 🎮 遊戲、🎁 獎勵、📈 股市、🔄 交易、🃏 卡牌、⭐ 願望、💸 轉帳、📦 其他
  - 每個類別顯示總額和 Top 5 項目
- **主要收入來源分析** - 同樣按類別分組
- **股票投資組合** - 顯示總市值、持股比例、排序優化

### 3. 🤝 互動排行 ⭐ 優化 + 排序功能
- **最常轉帳給您的人 Top 10**
  - 🥇🥈🥉 前三名獎牌顯示
  - 顯示總金額、次數、平均金額、佔比
  - 統計總計（總金額、總次數、平均）
  - **可切換排序方式**：按金額 💰 或按次數 🔢
- **您最常轉帳的人 Top 10**
  - 同樣的優化顯示格式
  - 同樣支援排序切換
  - 幫助識別主要交易對象

### 4. 🔍 使用模式分析 ⭐ 新功能
這是本次更新的核心功能，用於檢測異常使用模式：

#### 分析指標

1. **使用間隔分析**
   - 平均使用間隔
   - 間隔標準差
   - 間隔穩定度（變異係數 CV）

2. **使用頻率分析**
   - 最近 60 分鐘使用頻率
   - 每日平均使用次數
   - 總使用次數

3. **時間跨度分析**
   - 首次使用時間
   - 最後使用時間
   - 使用時間跨度

#### 可疑程度判定

系統會根據以下標準自動判定使用者的可疑程度：

**🚨 高度可疑（5分以上）**
- 使用間隔極度規律（CV < 10%）且使用次數 > 10
- 平均間隔 < 2 秒且使用次數 > 10
- 平均間隔 < 5 秒且使用次數 > 20
- 使用次數 > 200
- 每日平均使用次數 > 50

**⚠️ 可疑（3-4分）**
- 使用間隔過於規律
- 使用頻率異常高
- 使用次數偏高（100-200次）

**✅ 正常（0-2分）**
- 使用模式符合正常人類行為

### 5. 🕸️ 關係網路分析 ⭐ 全新功能
這是專門用於稽查的強大功能：

#### 網路統計
- 直接關係數（與目標帳號有交易的帳號數）
- 總交易次數和金額
- 平均關係強度（0-100 分）

#### 可疑集群檢測
自動檢測三種可疑模式：
1. **高頻互動集群** - 可能是小帳互刷
   - 交易次數 > 50 且關係強度 > 70
   - 可疑度：85/100
   
2. **大額交易集群** - 可能是洗錢
   - 總金額 > 100 萬且平均單筆 > 1 萬
   - 可疑度：75/100
   
3. **新帳號集群** - 可能是新建小帳
   - 首次交易 < 7 天且交易次數 > 20
   - 可疑度：90/100

#### 關係強度計算
基於三個維度計算（0-100 分）：
- 交易次數（40%）
- 交易金額（30%）
- 關係持續時間（30%）

#### 直接關係 Top 10
- 顯示關係強度條（█████）
- 顏色標示：🔴 高（≥70）、🟡 中（40-69）、🟢 低（<40）
- 交易統計和時間範圍

#### 間接關係（二度關係）
- 顯示與直接關係帳號有交易的其他帳號
- 幫助發現更大的關聯網路

### 6. 📝 詳細記錄
- 最近交易紀錄
- 卡片收藏總覽

## 使用方式

### Slash Command
```
/user-info [user:選填]
```

### Context Menu
右鍵點擊使用者 → 應用程式 → 使用者資訊

## UI 特色

### 使用 Discord Components v2
- **StringSelectMenu**: 下拉式選單切換不同資訊類別
- **Buttons**: 重新整理資料、匯出報告（開發中）
- **Markdown 格式化**: 使用 Discord 的 Markdown 語法呈現清晰的資訊

### 互動式介面
- 5 分鐘內可自由切換不同資訊類別
- 即時重新整理資料
- 僅指令執行者可操作（防止誤觸）

## 技術實作

### 資料來源
使用 `command_usage_stats` 表的現有欄位：
- `user_id`: 使用者 ID
- `guild_id`: 伺服器 ID
- `command_name`: 指令名稱
- `used_at`: 使用時間戳
- `success`: 是否成功執行

### 統計演算法

#### 變異係數（Coefficient of Variation, CV）
```
CV = (標準差 / 平均值) × 100%
```
用於衡量資料的相對變異程度：
- CV < 10%: 極度穩定（可疑）
- CV < 30%: 規律
- CV ≥ 30%: 正常變異

#### 使用間隔計算
使用 SQL 的 `LAG()` 視窗函數計算相鄰兩次使用的時間差：
```sql
EXTRACT(EPOCH FROM (used_at - LAG(used_at) OVER (PARTITION BY command_name ORDER BY used_at)))
```

### 效能優化
- 使用 CTE（Common Table Expression）優化複雜查詢
- 利用現有索引：`idx_command_usage_user_stats`
- 並行查詢多個資料來源
- Redis 快取使用者基本資訊

## 檢測原理

### 為什麼可以檢測小帳/機器人？

1. **人類行為特徵**
   - 使用間隔不規律（受思考時間、操作速度影響）
   - 使用頻率有高峰和低谷（受作息影響）
   - 變異係數通常 > 30%

2. **機器人/腳本特徵**
   - 使用間隔極度規律（程式化執行）
   - 可能在極短時間內大量使用
   - 變異係數通常 < 10%
   - 不受人類作息影響

3. **小帳特徵**
   - 短時間內大量使用特定指令
   - 使用模式單一（只用特定幾個指令）
   - 每日使用次數異常高

## 限制與注意事項

1. **誤判可能性**
   - 某些使用者可能有規律的使用習慣
   - 建議結合其他證據綜合判斷

2. **資料要求**
   - 需要足夠的歷史資料（至少 10 次使用記錄）
   - 新使用者可能無法準確分析

3. **隱私考量**
   - 僅管理員可使用
   - 資料僅用於伺服器管理目的

## 本次更新亮點 ✨

### UI/UX 改進
1. **千分位數字格式化** - 所有金額都使用 `toLocaleString()` 格式化，更易讀
2. **Emoji 視覺化** - 使用 emoji 增強資訊層次感
3. **分類整理** - 交易類型按類別分組，一目了然
4. **排名視覺化** - 前三名使用獎牌 🥇🥈🥉 顯示
5. **百分比顯示** - 股票持倉、交易佔比都顯示百分比

### 資料呈現優化
1. **財務總覽**
   - 支出/收入按 8 大類別分組
   - 每類別顯示總額和 Top 5 項目
   - 完整的交易類型中文化（40+ 種類型）

2. **互動排行**
   - 顯示平均金額（總額/次數）
   - 顯示佔比（個人/總計）
   - 統計總計資訊

3. **股票投資組合**
   - 顯示總市值
   - 每支股票顯示持倉比例
   - 按市值排序

## 未來規劃

- [ ] 匯出完整報告（PDF/JSON）
- [ ] 批次分析多個使用者
- [ ] 自動警報系統（檢測到高度可疑時通知管理員）
- [ ] 機器學習模型優化檢測準確度
- [ ] 視覺化圖表（使用時間分布、頻率趨勢）
- [ ] 交易類型趨勢分析（最近 7 天 vs 最近 30 天）

## 模組化架構

為了提高程式碼可維護性，user-info 指令已經模組化：

### 核心模組
- `src/commands/admin/user-info/index.ts` - 主指令入口
- `src/commands/admin/user-info/formatters.ts` - 格式化工具
- `src/commands/admin/user-info/analyzer.ts` - 使用模式分析
- `src/commands/admin/user-info/relationship-analyzer.ts` - 關係網路分析
- `src/commands/admin/user-info/content-generators.ts` - 內容生成器

### 支援模組
- `src/commands/user/userinfo/index.ts` - Context menu 實作
- `src/repositories/user.repository.ts` - 資料查詢邏輯
- `src/shared/database/types.ts` - 型別定義
- `src/utils/errorHandler.ts` - 指令使用記錄
- `src/events/interactionCreate.ts` - 事件處理與時間追蹤
