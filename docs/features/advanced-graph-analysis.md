# 進階圖論分析 - 社群網路演算法

## 概述

user-info 指令現在整合了多種進階的圖論和社群網路分析演算法，能夠自動發現複雜的帳號關聯模式。

## 實作的演算法

### 1. PageRank 演算法 👑

**用途**: 找出網路中的關鍵節點（可能是主帳號或中心節點）

**原理**: 
- 由 Google 創始人發明，用於網頁排名
- 一個節點的重要性取決於指向它的其他節點的重要性
- 迭代計算直到收斂

**公式**:
```
PR(A) = (1-d)/N + d * Σ(PR(Ti)/C(Ti))

其中：
- d = 阻尼係數 (0.85)
- N = 總節點數
- Ti = 指向 A 的節點
- C(Ti) = Ti 的出度
```

**應用場景**:
- 找出小帳集團的主帳號
- 識別交易網路的中心人物
- 發現洗錢網路的關鍵節點

**輸出**:
- Top 10 關鍵節點
- 每個節點的 PageRank 分數（0-100%）
- 排名（第 1-10 名）

**範例結果**:
```
👑 第 1 名 @主帳號 - 重要度分數: 15.23%
🥈 第 2 名 @小帳1 - 重要度分數: 8.45%
🥉 第 3 名 @小帳2 - 重要度分數: 7.12%
```

---

### 2. Louvain 社群檢測 🏘️

**用途**: 自動發現緊密連結的帳號群組

**原理**:
- 基於模組度優化的社群檢測演算法
- 迭代地將節點移動到能最大化模組度的社群
- 自動確定社群數量（不需要預先指定）

**模組度公式**:
```
Q = (內部連接數 / 總連接數)

高模組度 (>0.8) = 社群內部連接緊密
低模組度 (<0.3) = 社群結構不明顯
```

**可疑度評分標準**:
1. **高模組度** (+30 分) - 內部連接極度緊密 (>80%)
2. **適中大小** (+20 分) - 3-10 個帳號
3. **高交易頻率** (+25 分) - 平均 >20 次/人
4. **封閉群組** (+25 分) - 外部連接 <20%

**應用場景**:
- 自動發現小帳集團
- 識別洗錢網路
- 找出互刷群組

**輸出**:
- 所有檢測到的社群（至少 2 個成員）
- 每個社群的可疑度分數
- 內部/外部連接統計
- 模組度指標

**範例結果**:
```
🚨 社群 1 - 可疑度: 85/100
成員: 5 個帳號
- @主帳號
- @小帳1
- @小帳2
- @小帳3
- @小帳4

社群特徵:
- 內部連接: 45 條
- 外部連接: 3 條
- 模組度: 93.8%

可疑原因:
- 社群內部連接極度緊密 (模組度: 93.8%)
- 社群大小適中 (5 個帳號)
- 內部交易頻繁 (平均 22.5 次/人)
- 與外部交易少 (僅 6.3%)
```

---

### 3. 循環交易檢測 🔄

**用途**: 發現 A→B→C→A 的循環洗錢模式

**原理**:
- 使用深度優先搜尋 (DFS) 尋找循環
- 檢測 3-5 個節點的循環
- 分析循環的交易量和頻率

**可疑度評分標準**:
1. **三角循環** (+40 分) - A→B→C→A
2. **四角循環** (+35 分) - A→B→C→D→A
3. **高金額** (+30 分) - 總金額 >10 萬
4. **高頻率** (+30 分) - 總次數 >50

**應用場景**:
- 檢測洗錢行為
- 發現刷交易量
- 識別資金循環流動

**輸出**:
- Top 10 最可疑的循環
- 循環路徑
- 總金額和平均金額
- 可疑度分數

**範例結果**:
```
🚨 循環 1 - 可疑度: 100/100
路徑: @帳號A → @帳號B → @帳號C → @帳號A

統計:
- 總金額: 1,250,000 元
- 平均金額: 25,000 元

可疑原因:
- 三角循環交易
- 循環總金額高 (1,250,000 元)
- 循環交易頻繁 (50 次)
```

---

## 演算法比較

| 演算法 | 用途 | 優點 | 缺點 | 適用場景 |
|--------|------|------|------|----------|
| **PageRank** | 找關鍵節點 | 準確、經典 | 計算量大 | 找主帳號 |
| **Louvain** | 社群檢測 | 自動、快速 | 可能過度分割 | 找小帳集團 |
| **循環檢測** | 找循環交易 | 直觀、精確 | 只能找小循環 | 檢測洗錢 |
| **規則式** | 基於規則 | 可解釋性強 | 需要調整閾值 | 快速篩選 |

---

## 使用指南

### 基本流程

1. **執行指令**
   ```
   /user-info @可疑帳號
   ```

2. **切換到關係網路分析**
   - 選擇「🕸️ 關係網路分析」

3. **查看分析結果**
   - 👑 PageRank 關鍵節點
   - 🏘️ Louvain 社群檢測
   - 🔄 循環交易檢測
   - 🚨 規則式集群檢測

### 進階技巧

#### 技巧 1: 找出小帳集團主帳號
```
1. 查看 PageRank 關鍵節點
2. 找出排名第 1 的帳號
3. 對該帳號執行 user-info
4. 查看其直接關係
5. 確認是否為主帳號
```

#### 技巧 2: 驗證社群檢測結果
```
1. 查看 Louvain 社群檢測
2. 選擇可疑度最高的社群
3. 對社群成員逐一執行 user-info
4. 比對使用模式和交易時間
5. 確認是否為同一人操作
```

#### 技巧 3: 追蹤循環洗錢
```
1. 查看循環交易檢測
2. 找出高金額的循環
3. 記錄循環路徑
4. 對路徑上的每個帳號執行 user-info
5. 查看財務總覽，確認資金流向
```

---

## 效能考量

### 時間複雜度

- **PageRank**: O(k * E)，k = 迭代次數（20），E = 邊數
- **Louvain**: O(n * log n)，n = 節點數
- **循環檢測**: O(n * d^k)，d = 平均度數，k = 最大循環長度（5）

### 優化策略

1. **限制節點數**
   - 直接關係: 最多 50 個
   - 間接關係: 最多 20 個

2. **限制循環長度**
   - 最大循環長度: 5
   - 只檢測 Top 10 循環

3. **延遲載入**
   - 只在切換到關係網路頁面時才執行
   - 避免不必要的計算

### 預期執行時間

- 小型網路 (<20 節點): < 1 秒
- 中型網路 (20-50 節點): 1-3 秒
- 大型網路 (>50 節點): 3-5 秒

---

## 實際案例

### 案例 1: 發現 5 人小帳集團

**背景**: 懷疑某帳號使用多個小帳互刷

**分析過程**:
1. 執行 `/user-info @主帳號`
2. PageRank 顯示該帳號排名第 1（重要度 18.5%）
3. Louvain 檢測到一個 5 人社群，可疑度 92/100
4. 社群特徵：
   - 模組度 95.2%（極度緊密）
   - 內部交易 78 次
   - 外部交易僅 2 次
5. 循環檢測發現 3 個三角循環

**結論**: 確認為小帳集團，5 個帳號由同一人操作

---

### 案例 2: 追蹤洗錢網路

**背景**: 發現異常大額交易

**分析過程**:
1. 執行 `/user-info @可疑帳號`
2. 循環檢測發現 4 角循環：A→B→C→D→A
3. 循環總金額 250 萬元，可疑度 100/100
4. 對 A、B、C、D 逐一執行 user-info
5. 發現 4 個帳號的使用模式高度相似

**結論**: 確認為洗錢行為，4 個帳號循環轉移資金

---

### 案例 3: 識別互刷群組

**背景**: 多個帳號交易量異常高

**分析過程**:
1. 執行 `/user-info @帳號1`
2. Louvain 檢測到 8 人社群
3. 社群內部交易頻繁（平均 45 次/人）
4. PageRank 顯示 3 個關鍵節點
5. 查看使用模式分析，發現使用間隔極度規律

**結論**: 確認為互刷群組，8 個帳號互相刷交易量

---

## 調整參數

如果需要調整演算法參數，可以修改 `graph-algorithms.ts`：

### PageRank 參數
```typescript
calculatePageRank(
  graph,
  iterations: 20,      // 迭代次數（越多越準確但越慢）
  dampingFactor: 0.85  // 阻尼係數（通常 0.85）
)
```

### 循環檢測參數
```typescript
detectCycles(
  graph,
  relationships,
  maxCycleLength: 5    // 最大循環長度（3-7 較合適）
)
```

### 社群檢測閾值
在 `analyzeCommunity` 函數中調整：
```typescript
// 高模組度閾值
if (stats.modularity > 0.8) { ... }  // 改為 0.7 會更寬鬆

// 社群大小範圍
if (members.length >= 3 && members.length <= 10) { ... }

// 內部交易頻率
if (avgInternalEdges > 20) { ... }  // 改為 15 會更寬鬆
```

---

## 未來擴展

### 短期（已規劃）
- [x] PageRank 演算法
- [x] Louvain 社群檢測
- [x] 循環交易檢測
- [ ] 時間相關性分析
- [ ] 視覺化關係圖

### 中期（考慮中）
- [ ] Girvan-Newman 社群檢測
- [ ] Betweenness Centrality（中介中心性）
- [ ] Closeness Centrality（接近中心性）
- [ ] 最短路徑分析
- [ ] 連通分量分析

### 長期（研究中）
- [ ] 機器學習異常檢測
- [ ] 時間序列分析
- [ ] 預測模型（預測未來交易）
- [ ] 自動化警報系統
- [ ] 即時監控儀表板

---

## 參考資料

### 學術論文
1. **PageRank**: Page, L., et al. (1999). "The PageRank Citation Ranking"
2. **Louvain**: Blondel, V. D., et al. (2008). "Fast unfolding of communities"
3. **社群檢測**: Fortunato, S. (2010). "Community detection in graphs"

### 線上資源
- [NetworkX 文件](https://networkx.org/)
- [圖論基礎](https://en.wikipedia.org/wiki/Graph_theory)
- [社群網路分析](https://en.wikipedia.org/wiki/Social_network_analysis)

### 相關工具
- Gephi - 視覺化工具
- Cytoscape - 網路分析工具
- igraph - R/Python 圖論庫
