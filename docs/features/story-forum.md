# 故事論壇功能說明

## 概述

故事論壇系統是一個**故事發布與訂閱通知系統**，讓作者能夠發布故事討論串，讀者可以訂閱感興趣的故事，並在作者更新時收到通知。

## 核心理念

- **無格式限制**：作者可以自由發布任何形式的故事內容
- **訂閱制通知**：讀者主動訂閱感興趣的故事
- **作者主導**：作者決定何時推播更新通知給訂閱者
- **權限管理**：作者可以授權其他人協助管理討論串

## 功能特點

### 1. 故事發布流程

1. 作者在指定的故事論壇頻道創建討論串
2. Bot 會自動詢問是否要開啟訂閱功能（可選擇「是」、「暫不」或「不再詢問」）
3. 如果作者選擇開啟，系統會創建訂閱入口訊息
4. 讀者可以透過訂閱入口或指令訂閱故事

**自動詢問機制**
- 作者發布新討論串時，Bot 會發送私密訊息詢問是否開啟訂閱
- 選擇「是」會立即在討論串中創建訂閱入口
- 選擇「暫不」會跳過此次，下次發文時仍會詢問
- 選擇「不再詢問」會永久關閉此功能

### 2. 訂閱系統

#### 訂閱類型

**1. Release（正式發布）**
- 用於正式章節、完整內容的更新通知
- 適合追蹤正式發布的讀者

**2. Test（測試/預覽）**
- 用於草稿、測試內容、預覽版本
- 適合願意提供反饋的讀者

**3. 關注作者**
- 訂閱作者在該伺服器的所有故事討論串
- 當作者創建新討論串並開啟訂閱入口時會自動訂閱

#### 訂閱方式

**方式 1：透過訂閱入口**
- 點擊訂閱入口訊息下方的按鈕
- 選擇訂閱類型（Release/Test/關注作者）

**方式 2：使用指令**
```
/sf subscribe [type:release|test|author_all]
```
- 在討論串中使用此指令
- `type` 參數可選，預設為 `release`
- 訂閱後會顯示當前訂閱人數統計

**查看所有訂閱**
```
/sf view
```
- 列出你在伺服器中所有訂閱的故事
- 按討論串分組顯示訂閱類型

**取消訂閱**
```
/sf unsubscribe
```
- 在討論串中使用此指令取消訂閱
- 會移除該討論串的所有訂閱類型

### 3. 作者專屬功能

#### 發送更新通知
```
/sf notify <message_link> [type:release|test]
```
- `message_link`：更新內容的訊息連結（必填）
- `type`：通知類型，預設為 `release`
- 例如：`/sf notify https://discord.com/channels/.../... type:release`
- 系統會 @ 對應類型的所有訂閱者
- 通知訊息會包含訊息連結，方便讀者快速跳轉
- 作者本人不會被通知

#### 創建訂閱入口
```
/sf entry
```
- 在討論串中創建訂閱入口訊息
- 提供 Release、Test、關注作者 三種訂閱選項
- 每個討論串只能有一個訂閱入口

#### 釘選訊息
```
?pin
```
- 釘選重要訊息（如章節目錄、角色介紹）
- 使用方式：回覆想要釘選的訊息，然後輸入 `?pin`
- 作者或授權使用者可用

#### 取消釘選訊息
```
?unpin
```
- 取消釘選訊息
- 使用方式：回覆想要取消釘選的訊息，然後輸入 `?unpin`
- 作者或授權使用者可用

### 4. 權限管理

作者可以授權最多 5 位使用者（包含作者自己）協助管理討論串。

**新增權限**
```
/sf permissions add <user>
```
- 授權使用者使用 `/sf notify` 和 `/sf entry`
- 最多 5 位使用者（包含作者）

**移除權限**
```
/sf permissions remove <user>
```
- 移除使用者的管理權限
- 不能移除作者本人的權限

**查看權限列表**
```
/sf permissions list
```
- 列出所有有權限的使用者

## 管理指令

**設定故事論壇頻道** （管理員專用）
```
?forum story set <頻道ID>
```
- 將指定的論壇頻道設為故事論壇
- 僅管理員可用

**移除故事論壇頻道** （管理員專用）
```
?forum story remove <頻道ID>
```
- 移除故事論壇設定
- 僅管理員可用

**查看已設定的故事論壇** （管理員專用）
```
?forum story view
```
- 列出所有已設定的故事論壇頻道
- 僅管理員可用

## 資料庫結構

### story_forum_threads
儲存故事討論串的基本資訊：
- `thread_id`: 討論串 ID
- `guild_id`: 伺服器 ID
- `author_id`: 作者 ID
- `status`: 狀態（統一為 `validated`）
- `created_at`: 創建時間

### story_forum_subscriptions
儲存訂閱關係：
- `id`: 訂閱記錄 ID
- `thread_id`: 討論串 ID
- `user_id`: 訂閱者 ID
- `subscription_type`: 訂閱類型（`release`/`test`/`author_all`）
- `subscribed_at`: 訂閱時間

### story_forum_subscription_entries
儲存訂閱入口訊息：
- `thread_id`: 討論串 ID
- `message_id`: 訂閱入口訊息 ID
- `created_at`: 創建時間

### story_forum_permissions
儲存權限設定：
- `thread_id`: 討論串 ID
- `user_id`: 被授權的使用者 ID
- `granted_at`: 授權時間

### story_forum_author_preferences
儲存作者偏好設定：
- `author_id`: 作者 ID
- `guild_id`: 伺服器 ID
- `ask_on_post`: 是否在發文時自動詢問（布林值）
- `updated_at`: 更新時間

## 使用範例

### 作者發布故事並啟用訂閱

1. 作者在故事論壇創建討論串
2. Bot 私訊詢問是否開啟訂閱功能
3. 作者點擊「是」，系統在討論串中創建訂閱入口
4. 讀者可以透過按鈕或指令訂閱

### 作者發送更新通知

1. 作者更新故事後，複製更新訊息的連結
2. 使用 `/sf notify <message_link> type:release`
3. 所有訂閱 Release 的讀者會收到 @ 通知
4. 通知訊息包含訊息連結，讀者可以直接跳轉

### 讀者訂閱故事

**方式 1：透過訂閱入口**
1. 在討論串中找到訂閱入口訊息
2. 點擊對應的訂閱按鈕（Release/Test/關注作者）
3. 系統確認訂閱成功

**方式 2：使用指令**
1. 在討論串中使用 `/sf subscribe type:release`
2. 系統確認訂閱成功並顯示訂閱統計

### 作者授權協作者

1. 使用 `/sf permissions add @協作者`
2. 協作者即可使用 `/sf notify` 和 `/sf entry`
3. 使用 `/sf permissions list` 查看所有授權的使用者

## 指令總覽

### Slash Commands（使用 `/sf` 指令）

**讀者可用**
- `/sf subscribe [type]` - 訂閱故事更新
- `/sf unsubscribe` - 取消訂閱
- `/sf view` - 查看所有訂閱

**作者/授權者可用**
- `/sf notify <message_link> [type]` - 發送更新通知
- `/sf entry` - 創建訂閱入口
- `/sf permissions add <user>` - 新增管理權限
- `/sf permissions remove <user>` - 移除管理權限
- `/sf permissions list` - 查看權限列表

### Prefix Commands

- `?pin` - 釘選訊息（回覆訊息後使用，作者/授權者可用）
- `?unpin` - 取消釘選訊息（回覆訊息後使用，作者/授權者可用）

### 管理員指令

- `?forum story set <頻道ID>` - 設定故事論壇頻道
- `?forum story remove <頻道ID>` - 移除故事論壇頻道
- `?forum story view` - 查看已設定的故事論壇

## 注意事項

1. **訂閱入口**：每個討論串只能有一個訂閱入口訊息
2. **權限限制**：最多 5 位使用者可以管理單一討論串（包含作者）
3. **訂閱類型**：單一討論串中，一位使用者可以同時訂閱多種類型
4. **關注作者**：選擇「關注作者」會自動訂閱該作者在同伺服器的所有新討論串
5. **通知範圍**：`/sf notify` 只會通知對應類型的訂閱者
6. **訊息連結**：`/sf notify` 和 `?pin`/`?unpin` 都需要提供訊息連結
7. **自動詢問**：可以透過「不再詢問」選項永久關閉發文時的自動詢問
8. **訂閱資料**：訂閱資料會永久保存，直到使用者主動取消
9. **指令類型**：`/sf` 是 Guild command，僅在設定的伺服器中可用

## 最佳實踐

### 作者建議

1. **善用訂閱類型**：
   - 使用 Release 通知正式更新
   - 使用 Test 徵求草稿反饋
   
2. **建立訂閱入口**：
   - 在討論串開頭創建訂閱入口
   - 方便新讀者快速訂閱

3. **授權協作者**：
   - 如果有共同作者或編輯，可以授權他們
   - 最多 5 位使用者可以管理

4. **使用釘選功能**：
   - 釘選章節目錄、角色介紹等重要資訊
   - 方便讀者查閱

### 讀者建議

1. **選擇合適的訂閱類型**：
   - 只想追正式更新：訂閱 Release
   - 願意提供反饋：同時訂閱 Release 和 Test
   - 追蹤作者所有作品：選擇關注作者

2. **使用 `/sf view`**：
   - 定期檢視自己訂閱的故事
   - 管理訂閱列表

3. **取消不再追蹤的故事**：
   - 使用 `/sf unsubscribe` 取消訂閱
   - 保持訂閱列表整潔
