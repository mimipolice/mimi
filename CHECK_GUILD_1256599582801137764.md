# 檢查伺服器 1256599582801137764 的 Bot 存取權限

## 問題

Bot 沒有收到該伺服器的 messageCreate 事件，但其他伺服器正常。

## 快速檢查

### 1. 執行伺服器存取檢查腳本

```bash
npm run build
node dist/scripts/check-guild-access.js
```

這會告訴你：
- ✅/❌ Bot 是否在該伺服器
- ✅/❌ Bot 有哪些權限
- ✅/❌ Bot 能看到哪些頻道
- ✅/❌ Bot 的角色設定

### 2. 檢查 Bot 是否在伺服器中

在 Discord 中：
1. 進入伺服器 `1256599582801137764`
2. 查看成員列表
3. 搜尋你的 Bot 名稱
4. 確認 Bot 在線（綠色圓點）

### 3. 檢查 Bot 角色權限

在 Discord 中：
1. 伺服器設定 → 角色
2. 找到 Bot 的角色
3. 確認以下權限已啟用：
   - ☑️ **檢視頻道** (View Channels)
   - ☑️ **讀取訊息歷史** (Read Message History)
   - ☑️ **發送訊息** (Send Messages)
   - ☑️ **管理成員** (Moderate Members) - 用於 timeout

### 4. 檢查頻道權限

在 Discord 中：
1. 右鍵點擊你要測試的頻道
2. 編輯頻道 → 權限
3. 找到 Bot 的角色或 @everyone
4. 確認以下權限：
   - ☑️ **檢視頻道** (View Channel)
   - ☑️ **讀取訊息歷史** (Read Message History)
   - ☑️ **發送訊息** (Send Messages)

### 5. 測試 Bot 是否能看到頻道

在該伺服器的任一頻道中：
1. 使用任何 slash command，例如 `/ping`
2. 如果 Bot 能回應，表示它能看到該頻道

### 6. 檢查日誌中的伺服器 ID

```bash
# 重新編譯（包含新的除錯日誌）
npm run build
pm2 restart your-bot-name

# 清空並監控日誌
pm2 logs your-bot-name --lines 0

# 然後在該伺服器發送訊息
```

你應該會看到：
```
[messageCreate] Message from YourName in guild 1256599582801137764 channel 1234567890
```

如果看到其他伺服器的 ID 但沒有看到 `1256599582801137764`，表示 Bot 確實沒有收到該伺服器的事件。

## 常見問題

### Q1: Bot 在伺服器中但看不到任何頻道

**原因**: Bot 的角色沒有 "View Channels" 權限

**解決**:
1. 伺服器設定 → 角色
2. 找到 Bot 的角色
3. 啟用 "View Channels" 權限
4. 或者在每個頻道的權限設定中，明確允許 Bot 角色

### Q2: Bot 能回應 slash commands 但收不到訊息

**原因**: 缺少 "Read Message History" 權限或 MESSAGE CONTENT INTENT

**解決**:
1. 檢查角色權限中的 "Read Message History"
2. 確認 Discord Developer Portal 中的 MESSAGE CONTENT INTENT 已啟用

### Q3: Bot 不在該伺服器

**原因**: Bot 可能被踢出或從未加入

**解決**:
使用 Bot 邀請連結重新加入：
```
https://discord.com/api/oauth2/authorize?client_id=1401130025411018772&permissions=1099780063302&scope=bot%20applications.commands
```

權限說明：
- `1099780063302` 包含所有必要權限
- 包含 Moderate Members (timeout)
- 包含 View Channels, Send Messages, Read Message History

### Q4: 檢查腳本顯示 Bot 不在伺服器

執行以下命令查看 Bot 在哪些伺服器：

```bash
node dist/scripts/check-guild-access.js
```

會列出所有 Bot 加入的伺服器。

## 手動測試步驟

### 測試 1: Slash Command

在伺服器中執行：
```
/ping
```

- ✅ 如果有回應：Bot 在伺服器中且有基本權限
- ❌ 如果沒回應：Bot 不在伺服器或沒有權限

### 測試 2: 訊息事件

1. 在 VPS 上監控日誌：
   ```bash
   pm2 logs your-bot-name --lines 0
   ```

2. 在 Discord 該伺服器發送訊息：
   ```
   test message
   ```

3. 檢查日誌是否出現該伺服器的 ID

### 測試 3: 其他伺服器對比

1. 在**能正常工作的伺服器**發送訊息
2. 在**問題伺服器**發送訊息
3. 對比日誌輸出的差異

## 修復後驗證

完成修復後：

```bash
# 1. 重啟 Bot
pm2 restart your-bot-name

# 2. 執行檢查腳本
node dist/scripts/check-guild-access.js

# 3. 在該伺服器發送訊息並檢查日誌
pm2 logs your-bot-name --lines 20

# 4. 測試 anti-spam（快速發送 5 條訊息）
```

## 預期結果

修復後，在該伺服器發送訊息應該看到：

```
[messageCreate] Message from YourName in guild 1256599582801137764 channel 1234567890
[Anti-Spam] Processing message from YourName (1191600548844163194) in guild 1256599582801137764
[Anti-Spam] Settings for guild 1256599582801137764: { ... }
[Anti-Spam] No spam detected, updating cache for YourName
```

監控腳本也應該顯示快取更新。
